<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Indie Search</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <meta
      name="description"
      content="A throwback search experience that lets you plug in your own Exa API key."
    />
    <style>
      :root {
       font-family: "Georgia", "Times New Roman", serif;
        --body-bg: #f7f7f7;
        --shell-bg: #fff;
        --border-color: #ddd;
        --text-color: #111;
        --subtext: #555;
        --muted: #666;
        --hotkey-text: #777;
        --result-border: #eee;
        --result-bg: #fff;
        --result-highlight-bg: #f1f3ff;
        --result-highlight-border: #cfd8ff;
        --link-color: #1a0dab;
        --desc-color: #3c4043;
        --url-color: #007200;
        --panel-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        --button-bg: #1a73e8;
        --button-border: #1a73e8;
        --control-panel-width: min(640px, 100%);
      }

      html[data-theme="dark"] {
        --body-bg: #0c0d11;
        --shell-bg: #14161f;
        --border-color: #2e2f3f;
        --text-color: #eceff4;
        --subtext: #c0c4d7;
        --muted: #a7a9b8;
        --hotkey-text: #c5c7d8;
        --result-border: #1f2029;
        --result-bg: #1c1f2a;
        --result-highlight-bg: rgba(112, 129, 255, 0.18);
        --result-highlight-border: rgba(112, 129, 255, 0.5);
        --link-color: #8ab4f8;
        --desc-color: #e8eaed;
        --url-color: #8abf3b;
        --panel-shadow: 0 12px 35px rgba(0, 0, 0, 0.7);
        --button-bg: #8ab4f8;
        --button-border: #8ab4f8;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--body-bg);
        display: flex;
        justify-content: center;
        padding: 2rem 1rem 2.5rem;
      }

      .shell {
        width: min(920px, 100%);
        background: var(--shell-bg);
        border: 1px solid var(--border-color);
        border-radius: 18px;
        box-shadow: var(--panel-shadow);
        padding: 2rem 2.5rem 2.75rem;
      }

      .logo {
        font-size: 2.1rem;
        letter-spacing: -0.02em;
        margin: 0;
        text-align: center;
        font-weight: 700;
      }

      .logo span {
        font-family: "Arial", sans-serif;
      }

      .logo .blue {
        color: #1a73e8;
      }

      .logo .red {
        color: #ea4335;
      }

      .logo .yellow {
        color: #fbbc05;
      }

      .logo .green {
        color: #34a853;
      }

      .section {
        margin-top: 1.6rem;
        font-family: "Arial", sans-serif;
      }

      .key-panel {
        padding-bottom: 1.6rem;
        border-bottom: 1px solid #e0e0e0;
      }

      .label {
        display: block;
        font-size: 0.95rem;
        margin-bottom: 0.45rem;
        color: var(--subtext);
      }

      input {
        width: 100%;
        border: 1px solid #cfcfcf;
        border-radius: 6px;
        padding: 0.85rem 0.95rem;
        font-size: 1rem;
        font-family: inherit;
        background: #fff;
        transition: border 0.15s ease;
      }

      input:focus {
        border-color: #4d90fe;
        outline: none;
      }

      .field-row {
        display: flex;
        gap: 0.8rem;
      }

      #api-key {
        max-width: 85%;
      }

      .field-row button,
      .search-input button {
        min-height: 2.8rem;
        align-self: stretch;
      }

      .key-entry-row.hidden {
        display: none;
      }

      button {
        border: 1px solid var(--button-border);
        border-radius: 5px;
        background: var(--button-bg);
        color: #fff;
        font-weight: 600;
        cursor: pointer;
        padding: 0 1.6rem;
        transition: background 0.2s ease;
      }

      button:hover:not(:disabled) {
        background: #1659c3;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #93b7ff;
      }

      .key-status {
        font-size: 0.85rem;
        color: var(--subtext);
        margin: 0.6rem 0 0;
      }


      .key-note {
        font-size: 0.83rem;
        color: var(--muted);
        margin: 0.25rem 0 0;
        line-height: 1.4;
      }

      .key-status-panel {
        margin-top: 0.65rem;
        margin-bottom: 12px;
        padding: 0.75rem 0.9rem;
        border-radius: 8px;
        background: rgba(26, 115, 232, 0.08);
        border: 1px solid rgba(26, 115, 232, 0.25);
      }

      .key-status-panel .key-status {
        margin: 0;
        font-weight: 600;
        color: var(--text-color);
      }

      .settings-row {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
        flex-wrap: wrap;
        margin-top: 0.8rem;
        width: 100%;
        max-width: var(--control-panel-width);
        margin: 0 0 0.8rem;
        justify-content: flex-start;
      }

      .css-override-block {
        flex: 1 1 280px;
        min-width: 0;
        width: 100%;
        align-self: flex-start;
      }

      .css-override-field {
        display: flex;
        gap: 0.75rem;
        align-items: flex-start;
        flex-wrap: wrap;
      }

      .css-override-field input {
        flex: 1 1 220px;
        min-width: 0;
      }

      #css-override-url {
        max-width: 85%;
      }

      .css-override-actions {
        display: flex;
        gap: 0.35rem;
        align-items: center;
      }

      .circle-action-button {
        width: 2.9rem;
        height: 2.9rem;
        border-radius: 999px;
        border: 1px solid var(--button-border);
        background: var(--button-bg);
        color: #fff;
        font-size: 1.3rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        padding: 0;
        transition: background 0.2s ease, border-color 0.2s ease;
      }

      .circle-action-button:hover:not(:disabled) {
        background: #1659c3;
      }

      .circle-action-button.css-override-clear {
        background: transparent;
        border-color: #cfcfcf;
        color: var(--text-color);
      }

      .circle-action-button.css-override-clear:hover:not(:disabled) {
        border-color: var(--link-color);
        color: var(--link-color);
        background: rgba(26, 115, 232, 0.04);
      }

      .circle-action-button.css-override-clear:disabled {
        border-color: var(--muted);
        color: var(--muted);
        cursor: not-allowed;
        background: transparent;
      }

      .css-override-status {
        margin-top: 0.35rem;
        font-size: 0.8rem;
        color: var(--muted);
        max-width: 580px;
      }

      .css-override-status[data-state="error"] {
        color: #d93025;
      }

      .css-override-status[data-state="loading"] {
        color: var(--subtext);
      }


      .provider-row {
        display: flex;
        gap: 0.6rem;
        align-items: center;
        margin-bottom: 0.75rem;
      }

      .provider-key-row {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
        flex-wrap: wrap;
        width: 100%;
        max-width: var(--control-panel-width);
        margin: 0 0 0.6rem;
        justify-content: flex-start;
      }

      .provider-key-row .provider-col {
        flex: 1 1 120px;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .provider-key-row form {
        flex: 1 1 320px;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
      }

      .select-control {
        width: 205px;
        border-radius: 5px;
        border: 1px solid #cfcfcf;
        padding: 0.7rem 0.85rem;
        font-size: 0.95rem;
        background: #fff;
        font-family: inherit;
      }

      .provider-note {
        font-size: 0.78rem;
        color: var(--subtext);
      }

      .provider-note a {
        color: var(--subtext);
        text-decoration: underline;
      }

      .country-picker {
        margin-top: 0;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        align-self: flex-start;
      }

      .key-panel {
        position: relative;
      }

      .key-panel .key-panel-content {
        display: block;
      }

      .key-panel.collapsed .key-panel-content {
        display: none;
      }

      .key-panel-toggle {
        margin-top: 0.75rem;
        border: none;
        background: none;
        color: #1a73e8;
        font-weight: 600;
        cursor: pointer;
        padding: 0;
        font-size: 0.9rem;
      }

      .key-panel-toggle.hidden {
        display: none;
      }

      .search-panel {
        margin-top: 0.85rem;
      }

      .hotkeys-note {
        font-size: 0.78rem;
        color: var(--hotkey-text);
        margin-top: 0.5rem;
      }

      .theme-toggle {
        margin-top: 0.7rem;
        font-size: 0.8rem;
        color: var(--muted);
        display: flex;
        align-items: center;
        gap: 0.35rem;
      }

      .theme-toggle .theme-toggle-group {
        display: flex;
        gap: 0.4rem;
      }

      .theme-toggle button.small-pill {
        padding: 0.25rem 0.85rem;
        border-radius: 999px;
        font-size: 0.78rem;
        border: 1px solid transparent;
        background: none;
        color: var(--subtext);
        cursor: pointer;
        transition: background 0.2s ease, border 0.2s ease;
      }

      .theme-toggle button.small-pill.active {
        background: var(--button-bg);
        border-color: var(--button-border);
        color: #fff;
      }

      .theme-toggle button.small-pill:focus {
        outline: 2px solid var(--button-border);
        outline-offset: 2px;
      }

      .search-input {
        display: flex;
        gap: 0.9rem;
        align-items: center;
      }

      .search-input button {
        padding-left: 2rem;
        padding-right: 2rem;
      }

      .status-message {
        margin-top: 0.65rem;
        font-size: 0.85rem;
        color: var(--subtext);
        min-height: 1rem;
      }

      .status-message[data-state="error"] {
        color: #d93025;
      }

      .results-list {
        margin-top: 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 1.1rem;
      }

      .result-card {
        padding-bottom: 0.65rem;
        border-bottom: 1px solid var(--result-border);
        background: var(--result-bg);
      }

      .result-card:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }

      .result-card.highlighted {
        background: var(--result-highlight-bg);
        border-color: var(--result-highlight-border);
      }

      .result-card a {
        color: var(--link-color);
        font-size: 1.18rem;
        text-decoration: underline;
        font-family: "Arial", sans-serif;
      }

      .result-description {
        margin: 0.35rem 0 0;
        font-size: 0.95rem;
        color: var(--desc-color);
        font-style: italic;
      }

      .result-url {
        margin: 0.25rem 0 0;
        font-size: 0.82rem;
        color: var(--url-color);
        font-family: "Courier New", Courier, monospace;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
        width: 100%;
      }

      .result-place-holder {
        margin: 0;
        color: #767676;
        font-size: 0.95rem;
      }

      .footer-note {
        margin-top: 2rem;
        font-size: 0.8rem;
        color: #777;
        text-align: center;
      }

      .footer-note a {
        color: #777;
        text-decoration: underline;
      }

      @media (max-width: 800px) {
        .shell {
          padding: 1.5rem;
        }

        .field-row,
        .search-input {
          flex-direction: column;
        }

        .field-row.key-entry-row {
          flex-direction: row;
          flex-wrap: nowrap;
          align-items: center;
        }

        .field-row.css-override-field {
          flex-direction: row;
          flex-wrap: nowrap;
          align-items: center;
        }

        .logo {
        font-size: 2.1rem;
          letter-spacing: 0;
        }

        .logo span {
          display: inline-block;
          line-height: 1.2;
        }

        .hotkeys-note {
          display: none;
        }
      }
    </style>
    <style id="user-css-overrides"></style>
  </head>
  <body>
    <div class="shell">
      <p class="logo">
        <span class="blue">I</span>
        <span class="red">n</span>
        <span class="yellow">d</span>
        <span class="blue">i</span>
        <span class="green">e</span>
        <span> </span>
        <span class="blue">S</span>
        <span class="red">e</span>
        <span class="yellow">a</span>
        <span class="blue">r</span>
        <span class="green">c</span>
        <span class="red">h</span>
      </p>
      <section class="section key-panel" id="key-panel">
        <div class="key-panel-content" id="key-panel-content">
          <div class="key-status-panel" aria-live="polite">
            <p class="key-status" id="key-status">Key not saved yet.</p>
            <p class="key-note">
              This page keeps your key in local storage so it never leaves your browser unless you share it.
              Clear storage to remove it.
            </p>
          </div>
          <div class="provider-key-row">
            <div class="provider-col">
              <div class="provider-row">
                <select id="provider-select" class="select-control" aria-label="Choose search provider">
                  <option value="serper">Serper Search</option>
                  <option value="exa">Exa.ai (localhost only)</option>
                </select>
              </div>
              <span class="provider-note" id="provider-note">Exa full results</span>
            </div>
            <form id="key-form">
              <div class="field-row key-entry-row">
                <input id="api-key" type="password" autocomplete="off" placeholder="Required: Enter API key" />
                <button
                  id="save-key"
                  type="submit"
                  aria-label="Save API key"
                  title="Save API key"
                  class="circle-action-button"
                >
                  ✓
                </button>
              </div>
            </form>
          </div>
          <div class="settings-row">
            <div class="country-picker">
              <select id="country-select" class="select-control" aria-label="Select country">
                <option value="us">United States</option>
                <option value="ca">Canada</option>
                <option value="gb">United Kingdom</option>
                <option value="au">Australia</option>
                <option value="de">Germany</option>
                <option value="fr">France</option>
                <option value="jp">Japan</option>
              </select>
            </div>
            <div class="css-override-block">
              <div class="field-row css-override-field">
                <input
                  id="css-override-url"
                  type="url"
                  autocomplete="off"
                  placeholder="Custom stylesheet URL (optional)"
                />
                <div class="css-override-actions">
                  <button
                    id="save-css-override"
                    type="button"
                    class="circle-action-button"
                    aria-label="Apply custom stylesheet"
                  >
                    ✓
                  </button>
                  <button
                    id="clear-css-override"
                    type="button"
                    class="circle-action-button css-override-clear"
                    disabled
                    aria-label="Remove custom stylesheet"
                  >
                    ✕
                  </button>
                </div>
              </div>
              <p id="css-override-status" class="key-note css-override-status">
                Paste a stylesheet URL (CORS-enabled) to override the look; saved locally for next time.
              </p>
            </div>
          </div>
        </div>
        <button
          class="key-panel-toggle hidden"
          id="toggle-key-panel"
          type="button"
          aria-expanded="false"
        >
        Settings
        </button>
      </section>
      <section class="section search-panel">
        <form class="search-input" id="search-form">
          <input id="search-input" name="s" autocomplete="off" placeholder="Search the indie web" />
          <button id="search-button" type="submit">Search</button>
        </form>
        <p class="hotkeys-note">
          Hotkeys: `/` focus search, `Ctrl+K` toggle the API key form, `↑/↓` (or `j/k`) to select a
          result, Enter to open it.
        </p>
        <div class="theme-toggle">
          <span>Theme:</span>
          <div class="theme-toggle-group" role="group" aria-label="Select theme">
            <button class="small-pill" data-theme-value="light" type="button">Light</button>
            <button class="small-pill" data-theme-value="dark" type="button">Dark</button>
            <button class="small-pill" data-theme-value="system" type="button">System</button>
          </div>
        </div>
        <p class="status-message" id="status-message"></p>
        <div class="results-list" id="results-list">
          <p class="result-place-holder">Awaiting your first search.</p>
        </div>
      </section>
      <p class="footer-note" id="footer-note">Results provided by Exa.ai.</p>
    </div>
    <script>
      const maxResults = 10;
      const sourceCodeUrl = "https://github.com/seven20solutions/indiesearch.git";
      const defaultProviderId = "serper";
      const providerConfigs = {
        exa: {
          label: "Exa.ai",
          storageKey: "indieSearchKey-exa",
          note: "Requires your Exa.ai API key.",
          requiresKey: true,
          async search(query, key) {
            const response = await fetch("https://api.exa.ai/search", {
              method: "POST",
              headers: {
                Accept: "application/json",
                "Content-Type": "application/json",
                "x-api-key": key,
              },
              body: JSON.stringify({
                query,
                type: "auto",
                userLocation: currentCountry,
                numResults: maxResults,
                contents: {
                  highlights: {
                    maxCharacters: 4000,
                  },
                },
              }),
            });

            if (!response.ok) {
              const text = await response.text();
              throw new Error(text || "Search failed. Please double-check your key.");
            }

            const payload = await response.json();
            const hits =
              payload?.results ||
              payload?.response?.results ||
              payload?.data?.results ||
              (Array.isArray(payload) ? payload : []);

            return hits.slice(0, maxResults).map((hit) => ({
              title:
                hit?.title || hit?.description || hit?.meta?.title || hit?.label || "Untitled result",
              url: hit?.url || hit?.link || hit?.metadata?.url || "",
              description: summarizeDescription(hit),
            }));
          },
        },
        serper: {
          label: "Serper Search",
          storageKey: "indieSearchKey-serper",
          note: "Requires a free <a href=\"https://serper.dev/\" target=\"_blank\" rel=\"noreferrer\">Serper API key</a>.",
          requiresKey: true,
          async search(query, key) {
            const params = new URLSearchParams({
              q: query,
              gl: currentCountry || "us",
              apiKey: key,
            });
            const response = await fetch(`https://google.serper.dev/search?${params}`, {
              method: "GET",
              redirect: "follow",
            });
            if (!response.ok) {
              throw new Error("Serper Search API returned an error.");
            }
            const data = await response.json();
            const hits = data?.organic || data?.results || [];
            return hits.slice(0, maxResults).map((entry) => ({
              title: entry?.title || entry?.titleNoFormatting || entry?.heading || query,
              url: entry?.link || entry?.url || entry?.displayLink || `https://google.serper.dev/search?q=${encodeURIComponent(query)}`,
              description:
                entry?.snippet || entry?.description || entry?.body || "Powered by Serper Search",
            }));
          },
        },
      };
      let currentProviderId = defaultProviderId;

      function getProviderConfig(id = currentProviderId) {
        return providerConfigs[id] || providerConfigs[defaultProviderId];
      }

      function loadProviderSelection() {
        try {
          const stored = localStorage.getItem(providerStorageKey);
          if (stored && providerConfigs[stored]) {
            currentProviderId = stored;
          }
        } catch (error) {
          console.warn("Unable to read provider selection", error);
        }
      }

      function syncProviderSelect() {
        if (providerSelect) {
          providerSelect.value = currentProviderId;
        }
      }

      function setProviderNote() {
        if (providerNote) {
          providerNote.innerHTML = getProviderConfig().note;
        }
      }

      function saveProviderSelection(value) {
        if (!value || !providerConfigs[value]) {
          return;
        }
        try {
          localStorage.setItem(providerStorageKey, value);
        } catch (error) {
          console.warn("Unable to persist provider", error);
        }
        currentProviderId = value;
        syncProviderSelect();
        setProviderNote();
      }

      const keyInput = document.getElementById("api-key");
      const keyForm = document.getElementById("key-form");
      const keyStatus = document.getElementById("key-status");
      const keyPanel = document.getElementById("key-panel");
      const toggleKeyPanel = document.getElementById("toggle-key-panel");
      const countrySelect = document.getElementById("country-select");
      const providerSelect = document.getElementById("provider-select");
      const providerNote = document.getElementById("provider-note");
      const countryStorageKey = "indieSearchCountry";
      const providerStorageKey = "indieSearchProvider";
      const customCssStorageKey = "indieSearchCustomCssUrl";
      const keyEntryRow = document.querySelector(".key-entry-row");
      let keyPanelCollapsed = false;
      const searchForm = document.getElementById("search-form");
      const searchInput = document.getElementById("search-input");
      const resultsList = document.getElementById("results-list");
      const searchButton = document.getElementById("search-button");
      const statusMessage = document.getElementById("status-message");
      const footerNote = document.getElementById("footer-note");
      const cssOverrideInput = document.getElementById("css-override-url");
      const cssOverrideSave = document.getElementById("save-css-override");
      const cssOverrideClear = document.getElementById("clear-css-override");
      const cssOverrideStatus = document.getElementById("css-override-status");
      const customCssStyle = document.getElementById("user-css-overrides");
      const countryNames = countrySelect
        ? Array.from(countrySelect.options).reduce((acc, option) => {
            acc[option.value] = option.textContent;
            return acc;
          }, {})
        : {};

      const normalizeText = (value) =>
        typeof value === "string"
          ? value
              .replace(/[\*`_#\[\]]/g, "")
              .replace(/\s+/g, " ")
              .trim()
          : "";

      const themeStorageKey = "indieSearchTheme";
      const systemMedia = window.matchMedia("(prefers-color-scheme: dark)");
      let themePreference = "system";
      let themeButtons = [];

      const buildHighlightArray = (hit) => {
        const highlights = [];
        if (Array.isArray(hit?.highlights)) {
          highlights.push(...hit.highlights);
        }
        if (Array.isArray(hit?.contents)) {
          hit.contents.forEach((entry) => {
            if (typeof entry === "string") {
              highlights.push(entry);
            } else if (entry?.text) {
              highlights.push(entry.text);
            }
          });
        }
        return highlights.map(normalizeText).filter(Boolean);
      };

      const summarizeDescription = (hit) => {
        if (hit?.description) {
          return normalizeText(hit.description);
        }
        if (hit?.summary) {
          return normalizeText(hit.summary);
        }
        if (hit?.snippet) {
          return normalizeText(hit.snippet);
        }
        const highlights = buildHighlightArray(hit);
        if (highlights.length) {
          const first = highlights[0];
          return first.length > 320 ? `${first.slice(0, 317)}...` : first;
        }
        return "No description available.";
      };

      function resolveTheme(pref) {
        if (pref === "system") {
          return systemMedia.matches ? "dark" : "light";
        }
        return pref;
      }

      function applyThemePreference(pref) {
        themePreference = pref;
        const resolved = resolveTheme(pref);
        document.documentElement.setAttribute("data-theme", resolved);
      }

      function updateThemeButtons(buttons) {
        buttons.forEach((btn) => {
          const value = btn.dataset.themeValue;
          const isActive = value === themePreference;
          btn.classList.toggle("active", isActive);
          btn.setAttribute("aria-pressed", isActive.toString());
        });
      }

      let currentKey = null;
      let currentResults = [];
      let highlightedIndex = -1;
      let currentCountry = "us";
      let customCssUrl = null;

      function setStatus(message, state) {
        statusMessage.textContent = message;
        if (state) {
          statusMessage.setAttribute("data-state", state);
        } else {
          statusMessage.removeAttribute("data-state");
        }
      }

      function updateKeyStatus(forceCollapse = true) {
        const provider = getProviderConfig();
        if (!provider.requiresKey) {
          keyStatus.textContent = "Key not required for the selected provider.";
          searchButton.disabled = false;
          setStatus("");
          updateKeyVisibility(forceCollapse);
          updateKeyFieldVisibility();
          return;
        }

        if (currentKey) {
          keyStatus.textContent = "Key saved locally. Ready to search.";
          searchButton.disabled = false;
          setStatus("");
        } else {
          keyStatus.textContent = "Key not saved yet.";
          searchButton.disabled = true;
          setStatus("Enter a key above before searching.");
        }
        updateKeyVisibility(forceCollapse);
        updateKeyFieldVisibility();
        updateFooter();
      }

      function updateKeyFieldVisibility() {
        const provider = getProviderConfig();
        const requiresKey = !!provider.requiresKey;
        if (keyEntryRow) {
          keyEntryRow.classList.toggle("hidden", !requiresKey);
        }
        keyInput.disabled = !requiresKey;
      }

      function loadKeyFromStorage() {
        const provider = getProviderConfig();
        currentKey = null;
        keyInput.value = "";
        if (!provider.storageKey) {
          return;
        }
        try {
          const stored = localStorage.getItem(provider.storageKey);
          if (stored) {
            currentKey = stored;
            keyInput.value = stored;
          }
        } catch (error) {
          console.warn("Unable to access localStorage", error);
        }
      }

      function loadCountryFromStorage() {
        try {
          const stored = localStorage.getItem(countryStorageKey);
          if (stored) {
            currentCountry = stored;
          }
        } catch (error) {
          console.warn("Unable to access country storage", error);
        }
      }

      function syncCountrySelect() {
        if (!countrySelect) {
          return;
        }
        countrySelect.value = currentCountry;
      }

      function saveCountry(value) {
        if (!value) {
          return;
        }
        try {
          localStorage.setItem(countryStorageKey, value);
          currentCountry = value;
        } catch (error) {
          console.warn("Unable to store country", error);
        }
        updateFooter();
      }

      function getCountryDisplayName(code) {
        if (!code) {
          return "";
        }
        return countryNames[code] || code.toUpperCase();
      }

      function updateFooter() {
        if (!footerNote) {
          return;
        }
        const provider = getProviderConfig();
        const countryName = getCountryDisplayName(currentCountry);
        const providerText = `Results provided by ${provider.label}${
          countryName ? ` (${countryName})` : ""
        }.`;
        const link = `<a href="${sourceCodeUrl}" target="_blank" rel="noopener">Source Code</a>`;
        footerNote.innerHTML = `${providerText} ${link}`;
      }

      function setCssOverrideStatus(message, state) {
        if (!cssOverrideStatus) {
          return;
        }
        cssOverrideStatus.textContent = message;
        if (state) {
          cssOverrideStatus.setAttribute("data-state", state);
        } else {
          cssOverrideStatus.removeAttribute("data-state");
        }
      }

      function updateCssOverrideControls() {
        if (!cssOverrideClear) {
          return;
        }
        cssOverrideClear.disabled = !customCssUrl;
      }

      function applyCustomCssText(cssText) {
        if (customCssStyle) {
          customCssStyle.textContent = cssText || "";
        }
      }

      async function loadCustomCss(url, { persist = false } = {}) {
        if (!url) {
          setCssOverrideStatus("Enter a stylesheet URL to apply.", "error");
          return false;
        }
        setCssOverrideStatus("Loading custom stylesheet…", "loading");
        try {
          const response = await fetch(url, { mode: "cors" });
          if (!response.ok) {
            throw new Error(`Request failed (${response.status})`);
          }
          const cssText = await response.text();
          applyCustomCssText(cssText);
          customCssUrl = url;
          if (persist) {
            try {
              localStorage.setItem(customCssStorageKey, url);
            } catch (storageError) {
              console.warn("Unable to persist custom CSS URL", storageError);
            }
          }
          setCssOverrideStatus("Custom stylesheet applied.");
          return true;
        } catch (error) {
          console.error("Custom CSS override failed", error);
          setCssOverrideStatus(
            `Unable to load custom CSS${error?.message ? `: ${error.message}` : ""}`,
            "error"
          );
          return false;
        } finally {
          updateCssOverrideControls();
        }
      }

      function clearCustomCssOverride() {
        applyCustomCssText("");
        customCssUrl = null;
        try {
          localStorage.removeItem(customCssStorageKey);
        } catch (storageError) {
          console.warn("Unable to clear custom CSS URL", storageError);
        }
        setCssOverrideStatus("Custom stylesheet removed.");
        if (cssOverrideInput) {
          cssOverrideInput.value = "";
        }
        updateCssOverrideControls();
      }

      async function restoreCustomCssFromStorage() {
        try {
          const storedUrl = localStorage.getItem(customCssStorageKey);
          if (storedUrl && cssOverrideInput) {
            cssOverrideInput.value = storedUrl;
          }
          if (storedUrl) {
            await loadCustomCss(storedUrl);
            return;
          }
          setCssOverrideStatus("Paste a stylesheet URL (CORS-enabled) to override the look.");
        } catch (error) {
          console.warn("Unable to restore custom stylesheet", error);
          setCssOverrideStatus("Unable to load saved stylesheet.", "error");
        } finally {
          updateCssOverrideControls();
        }
      }

      function loadThemeFromStorage() {
        try {
          const stored = localStorage.getItem(themeStorageKey);
          if (stored) {
            themePreference = stored;
          }
        } catch (error) {
          console.warn("Unable to access theme storage", error);
        }
      }

      function saveKey() {
        const trimmed = keyInput.value.trim();
        if (!trimmed) {
          setStatus("Enter a valid key before saving.", "error");
          return;
        }

        const provider = getProviderConfig();
        if (!provider.storageKey) {
          currentKey = trimmed;
          updateKeyStatus();
          return;
        }

        try {
          localStorage.setItem(provider.storageKey, trimmed);
          currentKey = trimmed;
          setStatus("Key stored successfully.");
          updateKeyStatus();
        } catch (error) {
          console.error(error);
          setStatus("Unable to store the key — check your browser settings.", "error");
        }
      }

      function applyKeyPanelState() {
        if (!keyPanel) {
          return;
        }
        keyPanel.classList.toggle("collapsed", keyPanelCollapsed);
        if (!toggleKeyPanel) {
          return;
        }
        toggleKeyPanel.textContent = keyPanelCollapsed ? "Settings" : "Hide settings";
        toggleKeyPanel.setAttribute("aria-expanded", (!keyPanelCollapsed).toString());
      }

      function updateKeyVisibility(forceCollapse = true) {
        const hasKey = Boolean(currentKey);
        if (hasKey) {
          toggleKeyPanel.classList.remove("hidden");
          if (forceCollapse) {
            keyPanelCollapsed = true;
          }
        } else {
          toggleKeyPanel.classList.add("hidden");
          keyPanelCollapsed = false;
        }
        applyKeyPanelState();
      }

      function moveHighlight(delta) {
        const length = currentResults.length;
        if (!length) {
          return;
        }
        let next = highlightedIndex;
        if (next === -1) {
          next = delta > 0 ? 0 : length - 1;
        } else {
          next = Math.min(Math.max(0, next + delta), length - 1);
        }
        applyHighlight(next);
      }

      function activateHighlightedResult() {
        if (highlightedIndex < 0) {
          return;
        }
        const card = resultsList.querySelector(`.result-card[data-index="${highlightedIndex}"]`);
        const targetLink = card?.querySelector("a");
        if (targetLink) {
          targetLink.click();
        }
      }

      function buildResultCard(item) {
        const card = document.createElement("article");
        card.className = "result-card";

        const titleLink = document.createElement("a");
        titleLink.textContent = item.title;
        titleLink.href = item.url || "#";
        titleLink.target = "_blank";
        titleLink.rel = "noopener noreferrer";

        const description = document.createElement("p");
        description.className = "result-description";
        description.textContent = item.description;

        const meta = document.createElement("p");
        meta.className = "result-url";
        meta.textContent = item.url ? item.url : "Link unavailable";

        card.append(titleLink, description, meta);
        return card;
      }

      function renderResults(results) {
        resultsList.innerHTML = "";
        currentResults = results;
        highlightedIndex = -1;
        if (!results.length) {
          const placeholder = document.createElement("p");
          placeholder.className = "result-place-holder";
          placeholder.textContent = "No results yet. Try a different query.";
          resultsList.appendChild(placeholder);
          return;
        }

        results.forEach((result, index) => {
          const card = buildResultCard(result);
          card.dataset.index = index;
          resultsList.appendChild(card);
        });
      }

      function applyHighlight(index) {
        const cards = Array.from(resultsList.querySelectorAll(".result-card"));
        cards.forEach((card) => card.classList.remove("highlighted"));
        if (index < 0 || index >= cards.length) {
          highlightedIndex = -1;
          return;
        }
        highlightedIndex = index;
        cards[index].classList.add("highlighted");
        const link = cards[index].querySelector("a");
        if (link) {
          link.scrollIntoView({ block: "nearest", behavior: "smooth" });
        }
      }

      async function runSearch(query) {
        const provider = getProviderConfig();
        if (provider.requiresKey && !currentKey) {
          setStatus("Add a key before searching.", "error");
          return;
        }

        if (!query) {
          setStatus("Type something and press Search.", "error");
          return;
        }

        setStatus(`Searching for “${query}” with ${provider.label}`, "loading");
        searchButton.disabled = true;

        try {
          const response = await provider.search(query, currentKey);
          renderResults(response);
          const successMessage = response.length
            ? `Showing ${response.length} result${response.length === 1 ? "" : "s"}`
            : "No matches from the provider.";
          setStatus(successMessage);
          updateQuery(query);
        } catch (error) {
          console.error(error);
          renderResults([]);
          setStatus(error.message || "Search failed.", "error");
        } finally {
          searchButton.disabled = !currentKey;
        }
      }

      function updateQuery(query) {
        const params = new URLSearchParams(window.location.search);
        if (query) {
          params.set("s", query);
        } else {
          params.delete("s");
        }
        const queryString = params.toString();
        const newUrl = queryString ? `${window.location.pathname}?${queryString}` : window.location.pathname;
        window.history.replaceState({}, "", newUrl);
      }

      function decodeSearchParam(value) {
        if (!value) {
          return "";
        }
        try {
          const replaced = value.replace(/\+/g, " ");
          return decodeURIComponent(replaced);
        } catch (error) {
          return value.replace(/\+/g, " ");
        }
      }

      function syncQueryFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const searchParam = params.get("s");
        const decoded = decodeSearchParam(searchParam);
        if (decoded) {
          searchInput.value = decoded;
          if (currentKey) {
            runSearch(decoded);
          } else {
            setStatus("Save your key to load the saved search.");
          }
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadProviderSelection();
        syncProviderSelect();
        setProviderNote();
        loadKeyFromStorage();
        loadCountryFromStorage();
        loadThemeFromStorage();
        updateKeyStatus();
        syncCountrySelect();
        themeButtons = Array.from(document.querySelectorAll(".theme-toggle button[data-theme-value]"));
        applyThemePreference(themePreference);
        updateThemeButtons(themeButtons);

        keyForm.addEventListener("submit", (event) => {
          event.preventDefault();
          saveKey();
          if (searchInput.value.trim()) {
            runSearch(searchInput.value.trim());
          }
        });

        searchForm.addEventListener("submit", (event) => {
          event.preventDefault();
          runSearch(searchInput.value.trim());
        });

        if (toggleKeyPanel) {
          toggleKeyPanel.addEventListener("click", () => {
            keyPanelCollapsed = !keyPanelCollapsed;
            applyKeyPanelState();
            if (!keyPanelCollapsed) {
              keyInput.focus();
            }
          });
        }

        if (providerSelect) {
          providerSelect.addEventListener("change", (event) => {
            const value = event.target.value;
            if (!value || !providerConfigs[value]) {
              return;
            }
            saveProviderSelection(value);
            keyPanelCollapsed = false;
            applyKeyPanelState();
            loadKeyFromStorage();
            updateKeyStatus(false);
            updateFooter();
            setStatus(`Switched to ${getProviderConfig().label}.`);
          });
        }

        if (countrySelect) {
          countrySelect.addEventListener("change", (event) => {
            saveCountry(event.target.value);
          });
        }

        themeButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const value = button.dataset.themeValue;
            if (!value) {
              return;
            }
            localStorage.setItem(themeStorageKey, value);
            applyThemePreference(value);
            updateThemeButtons(themeButtons);
          });
        });

        if (cssOverrideSave) {
          cssOverrideSave.addEventListener("click", async () => {
            const url = cssOverrideInput?.value.trim();
            if (!url) {
              setCssOverrideStatus("Enter a stylesheet URL to apply.", "error");
              return;
            }
            await loadCustomCss(url, { persist: true });
          });
        }

        if (cssOverrideClear) {
          cssOverrideClear.addEventListener("click", clearCustomCssOverride);
        }

        restoreCustomCssFromStorage();

        document.addEventListener("keydown", (event) => {
          const active = document.activeElement;
          const isEditable =
            active &&
            (active.tagName === "INPUT" ||
              active.tagName === "TEXTAREA" ||
              active.isContentEditable);

          if (
            event.key === "/" &&
            !event.metaKey &&
            !event.ctrlKey &&
            !event.altKey &&
            !isEditable
          ) {
            event.preventDefault();
            searchInput.focus();
            return;
          }

          if (event.ctrlKey && event.key.toLowerCase() === "k") {
            event.preventDefault();
            if (!currentKey) {
              keyInput.focus();
              return;
            }
            keyPanelCollapsed = !keyPanelCollapsed;
            applyKeyPanelState();
            if (!keyPanelCollapsed) {
              keyInput.focus();
            }
            return;
          }

          if (isEditable) {
            return;
          }

          if (event.key === "ArrowDown" || event.key.toLowerCase() === "j") {
            event.preventDefault();
            moveHighlight(1);
            return;
          }

          if (event.key === "ArrowUp" || event.key.toLowerCase() === "k") {
            event.preventDefault();
            moveHighlight(-1);
            return;
          }

          if (event.key === "Enter") {
            activateHighlightedResult();
            return;
          }
        });

        syncQueryFromUrl();
      });

      const handleSystemThemeChange = () => {
        if (themePreference === "system") {
          applyThemePreference("system");
          updateThemeButtons(themeButtons);
        }
      };

      if (systemMedia.addEventListener) {
        systemMedia.addEventListener("change", handleSystemThemeChange);
      } else if (systemMedia.addListener) {
        systemMedia.addListener(handleSystemThemeChange);
      }
    </script>
  </body>
</html>
